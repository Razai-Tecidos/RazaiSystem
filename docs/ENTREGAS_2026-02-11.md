# Entregas Consolidadas - 2026-02-11

Ultima atualizacao: 2026-02-11
Escopo: Shopee + modulos core (cores/estampas/vinculos/imagens/catalogo) + qualidade operacional

## Resumo executivo

Este documento consolida as entregas implementadas nas ultimas ondas de trabalho, incluindo:
- conformidade de contrato com Shopee Open API,
- robustez de publicacao (lock, idempotencia, rollback),
- melhorias de UX no fluxo de criacao de anuncios,
- ajustes em estampas/vinculos para paridade visual e funcional com cores,
- endurecimento de qualidade (UTF-8 guard, scripts de validacao e preflight).

## Entregas por onda (Shopee anuncios)

### Onda 1 - Conformidade API + bugs criticos (concluida)

Principais entregas:
- contrato de atributos corrigido para `category_id_list` com fallback compativel;
- obrigatoriedade de marca ajustada para `is_mandatory`;
- size chart corrigido (`category_id`, `page_size`, suporte via `get_item_limit`);
- publish com `size_chart_info` quando aplicavel;
- `logistic_info` salvo no draft e respeitado no publish;
- ownership reforcado no `GET /api/shopee/products/:id`.

Referencias:
- `docs/SHOPEE_ANUNCIOS.md`
- `functions/src/services/shopee-category.service.ts`
- `functions/src/routes/shopee-item-limit.routes.ts`

### Onda 2 - Robustez de publicacao (concluida)

Principais entregas:
- lock transacional com TTL por draft (`publish_lock`);
- idempotencia quando item ja existe na Shopee;
- rollback com `delete_item` quando `add_item` passa e `init_tier_variation` falha;
- validacao pre-publish reforcada no backend (atributos, marca, logistica, size chart);
- bloqueios equivalentes no frontend para impedir avancar/publicar com obrigatorios pendentes.

Referencias:
- `functions/src/services/shopee-product.service.ts`
- `frontend/src/pages/CriarAnuncioShopee.tsx`
- `docs/SHOPEE_ANUNCIOS.md`

### Onda 3 - Performance/observabilidade (concluida)

Entregas da onda:
- O3.1: logs estruturados por etapa no publish:
  - etapas: `lock`, `validation`, `upload`, `add_item`, `init_tier_variation`, `rollback`, `persist`;
  - eventos de rota `POST /:id/publish` com `duration_ms`, `status_code` e contexto.
- O3.2: upload resiliente com:
  - pool de concorrencia controlada no publish,
  - retry/backoff para falhas transientes de upload.
- O3.3: cache por `shop_id + language` em categorias e logistica.
- O3.4: testes de regressao/contrato para upload resiliente, cache por idioma e hooks de categorias.
- Backlog pos-onda (concluido):
  - paginacao completa de marcas (`get_brand_list`) com agregacao de paginas no backend;
  - UX de erro orientada por endpoint Shopee nas rotas/componentes de criacao de anuncio;
  - gate de politica para impedir uso de endpoints Shopee bloqueados.

Referencias:
- `docs/SHOPEE_ANUNCIOS.md`

## Fluxo de criacao Shopee e precificacao (estado atual)

Entregas principais:
- step dedicado `tamanhos_precificacao` no fluxo:
  - `tecido -> cores -> tamanhos_precificacao -> imagens -> configuracoes -> preview`;
- precificacao com:
  - custo por metro,
  - margem percentual ou fixa,
  - margem por tamanho (override),
  - baixo valor e teto de comissao,
  - taxa de antecipacao de 3%;
- exibicao de lucro liquido por variacao e por metro;
- arredondamento de preco para cima priorizando centavos `,50` ou `,90`;
- validacoes de avancar por step atualizadas.

Referencias:
- `frontend/src/lib/shopeePricing.ts`
- `frontend/src/lib/shopeePricing.test.ts`
- `docs/SHOPEE_ANUNCIOS.md`

## Entregas em modulos core (fora do publish Shopee)

### Gestao de imagens
- controles de hover na imagem de modelo e imagem premium;
- ajuste de tamanho de thumbnail e icones;
- reorganizacao de acoes de tabela;
- regra para evitar processamento pesado de regeneracao em massa;
- persistencia de imagens e mosaicos no banco/storage.

### Cores, estampas e vinculos
- alinhamento da tabela de estampas para paridade com cores:
  - SKU, nome, preview, vinculos e acoes;
- reflexo de vinculos na pagina de vinculos com comportamento visual/logico consistente.
- checklist PDF de vinculos atualizado:
  - modo com thumbs e modo rapido sem thumbs,
  - paginacao inteligente para evitar iniciar tecido no fim da pagina quando ele cabe inteiro na proxima,
  - compressao de preview para reduzir peso do arquivo.
- estampas:
  - correcao do modal de descarte em edicoes sequenciais,
  - persistencia de `imagemThumb` para acelerar PDF/listas.

### Catalogo
- ajuste para usar imagem quadrada com logo/nome da cor no PDF;
- consolidacao de lista sem separacao artificial (lisos/estampados) quando aplicavel.

Referencias:
- `frontend/src/pages/GestaoImagens.tsx`
- `frontend/src/components/Estampas/EstampasTable.tsx`
- `frontend/src/pages/Vinculos.tsx`
- `frontend/src/components/Catalogo/CatalogoPdfDocument.tsx`
- `frontend/src/docs/GESTAO_IMAGENS.md`
- `frontend/src/docs/ESTAMPAS.md`
- `frontend/src/docs/VINCULOS.md`
- `frontend/src/docs/CATALOGO.md`

## Qualidade operacional e scripts

Entregas:
- guard rail global anti-mojibake/UTF-8 (`scripts/encoding_guard.py`);
- hook de pre-commit versionado (`.githooks/pre-commit`);
- script de validacao cross por escopo (`scripts/validate-change.ps1`);
- script de preflight da skill `razai-change-pilot` (`scripts/preflight.ps1`).

Observacao:
- skill `shopee-api` foi criada/ajustada em ambiente de skills para consulta de endpoints.
- skill `link-open-fallback` foi criada para abrir links sempre tentando primeiro o ultimo metodo que funcionou.

## Regras e configuracoes de dados

Atualizacoes relevantes:
- ajustes em `firestore.rules` e `storage.rules` para cobrir fluxos atualizados;
- manutencao de compatibilidade com drafts antigos (campos novos opcionais);
- persistencia de novos campos de precificacao e defaults Shopee.

## Commits de referencia (recentes)

- `89d3320` feat(shopee): fecha onda 2 com rollback test e validacao reforcada
- `60acd56` docs(shopee): reorganiza documentacao para navegacao agent-first
- `f2f94d4` feat: concluir onda 1 shopee com deploy e documentacao
- `9c02f37` Add preflight script for razai-change-pilot
- `47d4312` Alinha colunas de Estampas/Vinculos e atualiza docs
- `7fc0e84` feat: add shopee image step and enforce global UTF-8 guard
- `24026e1` feat: improve navigation UX, image management flow, and Shopee docs

## Proximo acompanhamento recomendado

1. Executar validacao cross apos mudancas em fluxo Shopee (`scripts/validate-change.ps1 -Scope cross`).
2. Manter `docs/SHOPEE_ANUNCIOS.md` atualizado quando houver mudanca de regra/contrato.
3. Manter este documento atualizado com novos commits de entrega.
